# Streamlit Community Cloud 技術限制

## 基本資訊

| 項目 | 內容 |
|------|------|
| 官方文件 | https://docs.streamlit.io/streamlit-community-cloud |
| 最後更新 | 2025-01 |
| 適用版本 | streamlit >= 1.40.0 |

---

## 免費層限制

| 項目 | 限制值 | 違反後果 |
|------|--------|----------|
| 記憶體上限 | 1 GB（保證），2.7 GB（不保證） | OOM Kill，容器崩潰 |
| CPU | 0.078 - 2 核心（動態分配） | 效能不可控 |
| 單檔上傳 | 200 MB | 上傳失敗 |
| 儲存空間 | 50 GB（無持久化保證） | 重啟後遺失 |
| 休眠觸發 | 閒置 12 小時 | 冷啟動延遲數秒至數十秒 |
| 原始碼 | 必須公開 GitHub repo | 無法私有化 |

---

## 觸發詞對照表

| 使用者說 | 判定 | 說明 | 變通方向 |
|----------|------|------|----------|
| 自動、排程、定時、背景執行、Cron | ❌ 不可行 | 無背景任務支援，閒置後休眠 | 改為「開啟時檢查」觸發 |
| 上傳圖片、上傳照片、上傳檔案 | ⚠️ 有限制 | 單檔上限 200MB，總記憶體 1GB | 上傳後立即處理並釋放 |
| 儲存、保存、本地檔案 | ❌ 不可行 | 容器重啟後本地檔案全部遺失 | 必須使用外部儲存服務 |
| 記住、保持狀態、下次開啟 | ⚠️ 有限制 | Session State 頁面重整後重置 | 狀態須持久化至外部 |
| 彈窗、Modal、對話框 | ⚠️ 要變通 | 原生 st.dialog 功能有限 | 使用 st.dialog 或 st.expander |
| 固定底部、Sticky、懸浮 | ⚠️ 要變通 | CSS 控制受限 | 需自訂 CSS 注入，效果不保證 |
| 拖拉、拖曳排序、Drag | ❌ 不可行 | 原生不支援 | 改用按鈕上下移動 |
| 即時更新、不刷新、局部更新 | ⚠️ 要變通 | 預設全頁 re-run | 使用 @st.fragment 局部更新 |
| 長時間運算、大量處理 | ⚠️ 有風險 | 無明確上限但會逾時 | 分批處理，顯示進度 |
| 私密、機密、敏感資料 | ⚠️ 有風險 | 免費版必須公開 GitHub repo | 敏感資料用 st.secrets 存放 |
| 即時雙向、WebSocket、推播 | ❌ 不可行 | 無 WebSocket 支援 | 改用手動重整或輪詢 |
| 動畫、過場效果、轉場 | ⚠️ 極受限 | CSS/JS 受限 | 接受無動畫或極簡動畫 |
| 像 App 一樣、原生體驗 | ⚠️ 期望管理 | Streamlit 是 Web App | 體驗不同於原生 App |

---

## UI 元件能力邊界

### ✅ 原生支援良好

| 需求 | 對應元件 | 備註 |
|------|----------|------|
| 多選項切換 | `st.pills`, `st.radio`, `st.selectbox` | pills 較新，視覺較現代 |
| 表單批次送出 | `st.form` + `st.form_submit_button` | 避免每個輸入都觸發 re-run |
| 資料表格 | `st.dataframe`, `st.data_editor` | data_editor 可編輯 |
| 對話介面 | `st.chat_message`, `st.chat_input` | 需搭配 `@st.fragment` |
| 串流輸出 | `st.write_stream` | 打字機效果 |
| 側邊欄 | `st.sidebar` | 固定左側 |
| 水平分頁 | `st.tabs` | 適合平行內容切換 |
| 展開收合 | `st.expander` | 適合次要資訊 |
| 彈窗 | `st.dialog` | 需用裝飾器定義 |
| 進度顯示 | `st.spinner`, `st.progress` | 長時間操作必備 |
| 短暫通知 | `st.toast`, `st.success`, `st.error` | 操作回饋 |
| 圖片顯示 | `st.image` | 支援多種格式 |
| 欄位排版 | `st.columns` | 水平並排 |
| 指標卡片 | `st.metric` | 顯示數值 + 變化量 |

### ⚠️ 需要變通

| 需求 | 問題 | 變通方式 |
|------|------|----------|
| 固定底部輸入框 | CSS 控制受限 | 自訂 CSS 注入，效果不保證 |
| 真正的 Modal 彈窗 | `st.dialog` 功能有限 | 接受限制，或用 `st.expander` 模擬 |
| 雙層畫面無縫切換 | 每次互動觸發全頁 re-run | 用狀態變數控制顯示區塊 + `@st.fragment` |
| 卡片點擊事件 | 無原生可點擊卡片 | 用 `st.button` 或 `st.container` 搭配按鈕 |
| 圖片預覽暫存區 | 無原生預覽元件 | 用 `st.columns` 排列縮圖 |
| 局部更新不刷新 | 預設全頁 re-run | 使用 `@st.fragment` 裝飾器 |

### ❌ 不可行

| 需求 | 原因 |
|------|------|
| 拖拉排序 | 原生不支援 |
| 即時雙向通訊 | 無 WebSocket |
| 複雜動畫過場 | CSS/JS 受限 |
| 手勢操作（滑動、捏合） | 無支援 |
| 背景自動更新 | 無背景執行 |

---

## 設計模式

### ✅ 推薦模式

| 情境 | 做法 | 原因 |
|------|------|------|
| 敏感資訊儲存 | 使用 `st.secrets` | 不會進入 repo |
| 對話介面 | `@st.fragment` 包裝 | 避免整頁刷新 |
| 長時間操作 | 顯示 `st.spinner` | 使用者知道在處理 |
| 圖片處理 | 處理完立即釋放 | 避免記憶體爆掉 |
| 狀態持久化 | 存到外部服務 | Session State 會重置 |

### ❌ 禁止模式

| 模式 | 問題 | 正確做法 |
|------|------|----------|
| `api_key = "sk-xxx"` | 金鑰外洩（公開 repo） | 用 `st.secrets["API_KEY"]` |
| `st.session_state['img'] = uploaded_file` | 記憶體爆掉 | 處理完立即釋放，不存原始檔 |
| 依賴本地檔案儲存 | 重啟後遺失 | 使用外部儲存 |
| 沒有 `@st.fragment` 的聊天介面 | 每次都整頁刷新 | 用 fragment 包裝 |

---

## 程式碼檢查點

| 檢查項目 | 錯誤模式 | 正確模式 |
|----------|----------|----------|
| API 金鑰 | `api_key = "sk-xxx"` | `api_key = st.secrets["API_KEY"]` |
| 圖片儲存 | `st.session_state['img'] = file` | 處理後 `del` 或不存入 |
| 對話介面 | 直接寫 `st.chat_input` | 用 `@st.fragment` 包裝 |
| 長時間操作 | 無任何提示 | 加上 `with st.spinner():` |
| 敏感設定 | 寫在程式碼裡 | 放入 `.streamlit/secrets.toml` |

---

## 資源估算公式

### 記憶體估算

```
基礎消耗：約 200 MB
每張圖片處理中：約 5-20 MB（視解析度）
DataFrame 載入：約 資料大小 × 2-3 倍

安全閾值：峰值 < 800 MB（預留 200 MB 緩衝）
```

### 建議上限

| 資源 | 建議上限 | 說明 |
|------|----------|------|
| 單次處理圖片 | ≤ 10 張 | 記憶體考量 |
| DataFrame 行數 | ≤ 100,000 行 | 效能考量 |
| 單檔上傳 | ≤ 50 MB | 安全起見 |

---

## 常見問題

### Q: App 閒置後冷啟動很慢怎麼辦？

**A:** 這是免費版的限制，無法避免。可以在首頁加上 loading 提示，讓使用者知道正在啟動。

### Q: 怎麼讓使用者「記住」設定？

**A:** Session State 在重整後會重置。需要持久化的設定必須存到外部服務（如 Google Sheets）。

### Q: 可以用付費版嗎？

**A:** 可以，但需要評估成本。付費版可以私有 repo、更多資源、自訂網域。

---

## 必要套件版本

```
streamlit>=1.40.0
```

---

*最後更新：2025-01*
